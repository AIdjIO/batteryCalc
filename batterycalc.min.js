function getData(){var e=document.getElementsByTagName("textarea")[0].value.replace(/(^\s*,)|(,\s*$)/g,"").split(",").map(e=>parseFloat(e));return[[...Array(e.length).keys()],e.map(e=>e/3.6)]}function calculateSpeedInfo(o){var e=document.getElementById("speed_info"),t=o.map((e,t)=>(o[t+1]||0)-e),n=t.filter(e=>0<e),n=(n.reduce((e,t)=>e+t,0)/n.length).toFixed(3),t=t.filter(e=>e<0),t=(t.reduce((e,t)=>e+t,0)/t.length).toFixed(3),a=o.reduce((e,t)=>e+t,0)||0,r=(a/o.length||0).toFixed(2);e.innerHTML=`<i>This drive cycle has a minimum speed of ${(3.6*Math.min(...o)).toFixed(2)||0} km/h, 
                                 a maximum speed of ${(3.6*Math.max(...o)).toFixed(2)||0} km/h,
                                 an average speed of ${(3.6*r).toFixed(2)} km/h, an average acceleration of ${n} m/s², 
                                 an average deceleration of ${t} m/s²and 
                                 a total distance of ${(a/1e3).toFixed(2)} km</i>`}function updatePlotly(e,t,o){var[n,a]=[...getData()];calculateSpeedInfo(a),e[0].x=n,e[0].y=a.map(e=>3.6*e),Plotly.react("speedPlot",e,t,o)}function acceleration(o){return o.map((e,t)=>(o[t+1]||e)-e)}function total_forces(o){let n=document.getElementById("edit-vehicle-mass").value,a=document.getElementById("edit-drag-coefficient").value,r=document.getElementById("edit-frontal-area").value,l=document.getElementById("edit-rolling-resistance").value;document.getElementById("edit-vehicle-range").value;let i=document.getElementById("edit-air-density").value,d=document.getElementById("edit-road-slope").value;return o.map((e,t)=>n*((o[t+1]||e)-e+9.81*l*Math.cos(d)+9.81*Math.sin(d))+.5*i*a*r*e*e)}function total_cycle_power(o){return total_forces(o).map((e,t)=>e*o[t]/1e3)}function totalMotorPowerCont(){var e=document.querySelectorAll("[data-drupal-selector='edit-front-motor-power-continuous']")[0],t=document.querySelectorAll("[data-drupal-selector='edit-rear-motor-power-continuous']")[0];return(e?+e.value:0)+(t?+e.value:0)}function totalMotorPowerPeak(){var e=document.querySelectorAll("[data-drupal-selector='edit-front-motor-power-peak']")[0],t=document.querySelectorAll("[data-drupal-selector='edit-rear-motor-power-peak']")[0];return(e?+e.value:0)+(t?+e.value:0)}function motorPwrActualCont(e){e=total_cycle_power(e);let t=totalMotorPowerCont(),o=document.getElementById("edit-powertrain-efficiency").value,n=document.getElementById("edit-regen-capacity").value;return e.map(e=>0<=e/o&&e/o<t?e/o:e/o>=t?t:e/o<0&&e/o<-t*n/100?-t*n/100:e/o)}function motorPwrActualPeak(e){e=total_cycle_power(e);let t=totalMotorPowerPeak(),o=document.getElementById("edit-powertrain-efficiency").value,n=document.getElementById("edit-regen-capacity").value;return e.map(e=>0<=e/o&&e<t?e:e/o>=t?t:e/o<0&&e/o<-t*n/100?-t*n/100:e/o)}function SOCCont(e){C=1e3*document.getElementById("pack_energy_container").value;e=currentActualCont(e);return soc=e.map((soc=100,e=>soc=Math.min(soc,100)-100*e/C))}function currentActualCont(e){e=motorPwrActualCont(e);let t=800;return e.map(e=>64e4-12*e*1e3<0?(t-Math.sqrt(64e4+12*e*1e3))/2/3:(t-Math.sqrt(64e4-12*e*1e3))/2/3)}function currentActualPeak(e){e=motorPwrActualPeak(e);let t=800;return e.map(e=>64e4-12*e*1e3<0?(t+Math.sqrt(64e4-12*e*1e3))/2/3:(t-Math.sqrt(64e4-12*e*1e3))/2/3)}function energy_regen_on(e){return motorPwrActualCont(e).map((sum=0,e=>sum+=e/3600))}function energy_regen_off(e){return motorPwrActualCont(e).map((sum=0,e=>0<e?sum+=e/3600:sum))}function plotSOCActualCont(e){var t;e.preventDefault(),-1<document.getElementById("speedPlot").data.map(e=>e.name).indexOf("SOC Cont")||([e,t]=[...getData()],t=SOCCont(t),Plotly.addTraces("speedPlot",{name:"SOC Cont",type:"scatter",x:e,y:t,xaxis:"x",yaxis:"y5",mode:"lines",line:{color:"rgb(55, 128, 191)",shape:"spline",smoothing:1.3,width:1}}))}function plotCurrentActualCont(e){var t;e.preventDefault(),-1<document.getElementById("speedPlot").data.map(e=>e.name).indexOf("Current Cont")||([e,t]=[...getData()],t=currentActualCont(t),Plotly.addTraces("speedPlot",{name:"Current Cont",type:"scatter",x:e,y:t,xaxis:"x",yaxis:"y4",mode:"lines",line:{shape:"spline",smoothing:1.3,width:1}}))}function plotCurrentActualPeak(e){var t;e.preventDefault(),-1<document.getElementById("speedPlot").data.map(e=>e.name).indexOf("Current Peak")||([e,t]=[...getData()],t=currentActualPeak(t),Plotly.addTraces("speedPlot",{name:"Current Cont",type:"scatter",x:e,y:t,xaxis:"x",yaxis:"y4",mode:"lines",line:{shape:"spline",smoothing:1.3,width:1}}))}function plotEnergyRegenOn(e){var t;e.preventDefault(),-1<document.getElementById("speedPlot").data.map(e=>e.name).indexOf("Energy Regen On")||([e,t]=[...getData()],t=energy_regen_on(t),Plotly.addTraces("speedPlot",{name:"Energy Regen On",type:"scatter",x:e,y:t,xaxis:"x",yaxis:"y3",mode:"lines",line:{shape:"spline",smoothing:1.3,width:1}}))}function plotEnergyRegenOff(e){var t;e.preventDefault(),-1<document.getElementById("speedPlot").data.map(e=>e.name).indexOf("Energy Regen Off")||([e,t]=[...getData()],t=energy_regen_off(t),Plotly.addTraces("speedPlot",{name:"Energy Regen Off",type:"scatter",x:e,y:t,xaxis:"x",yaxis:"y3",mode:"lines",line:{shape:"spline",smoothing:1.3,width:1}}))}function plotPwrDmnd(e){var t;e.preventDefault(),-1<document.getElementById("speedPlot").data.map(e=>e.name).indexOf("Power Demand")||([e,t]=[...getData()],t=total_cycle_power(t),Plotly.addTraces("speedPlot",{name:"Power Demand",type:"scatter",x:e,y:t,xaxis:"x",yaxis:"y2",mode:"lines",line:{shape:"spline",smoothing:1.3,width:1}}))}function plotPwrActualCont(e){e.preventDefault();e=document.getElementById("speedPlot").data;if(!(-1<e.map(e=>e.name).indexOf("Motor Power Actual")||-1<e.map(e=>e.name).indexOf("Max Power Limit")||-1<e.map(e=>e.name).indexOf("Min Power Limit"))){var[e,o]=[...getData()],o=motorPwrActualCont(o);let t=totalMotorPowerCont();Plotly.addTraces("speedPlot",{name:"Motor Power Actual",type:"scatter",x:e,y:o,mode:"lines",xaxis:"x",yaxis:"y2",line:{shape:"spline",smoothing:1.3,width:1}}),Plotly.addTraces("speedPlot",{name:"Max Power Limit",type:"scatter",x:e,y:e.map(e=>t),mode:"lines",xaxis:"x",yaxis:"y2",line:{color:"rgb(0, 0, 0)",shape:"linear",width:1}}),Plotly.addTraces("speedPlot",{name:"Min Power Limit",type:"scatter",x:e,y:e.map(e=>-t),mode:"lines",xaxis:"x",yaxis:"y2",line:{color:"rgb(0, 0, 0)",shape:"linear",width:1}})}}function plotPwrActualPk(e){e.preventDefault();e=document.getElementById("speedPlot").data;if(!(-1<e.map(e=>e.name).indexOf("Motor Power Peak")||-1<e.map(e=>e.name).indexOf("Max Peak Power Limit")||-1<e.map(e=>e.name).indexOf("Min Peak Power Limit"))){var[e,o]=[...getData()],o=motorPwrActualPeak(o);let t=totalMotorPowerPeak();Plotly.addTraces("speedPlot",{name:"Motor Power Peak",type:"scatter",x:e,y:o,mode:"lines",xaxis:"x",yaxis:"y2",line:{shape:"spline",smoothing:1.3,width:1}}),Plotly.addTraces("speedPlot",{name:"Max Peak Power Limit",type:"scatter",x:e,y:e.map(e=>t),mode:"lines",yaxis:"y2",line:{color:"rgb(0, 0, 0)",shape:"linear",width:1},visible:"legendonly"}),Plotly.addTraces("speedPlot",{name:"Min Peak Power Limit",type:"scatter",x:e,y:e.map(e=>-t),mode:"lines",yaxis:"y2",line:{color:"rgb(0, 0, 0)",shape:"linear",width:1},visible:"legendonly"})}}jQuery,Drupal.behaviors.plotlyjs={attach:function(e,t){var o=[],n={title:"Vehicle Test Cycle",xaxis:{domain:[0,.9],tickmode:"linear",tick0:0,dtick:500,anchor:"y",showspikes:!0},xaxis2:{domain:[0,.8],domain:[0,1],title:"time [s]",anchor:"y2",categoryorder:"array",showspikes:!0},yaxis:{title:"speed [km/h]",tickmode:"linear",tick0:0,dtick:20,titlefont:{color:"black"},tickfont:{color:"#black"},anchor:"x",domain:[.52,1],showspikes:!0},yaxis2:{title:"Power [kW]",titlefont:{color:"rgb(148, 103, 189)"},tickfont:{color:"rgb(148, 103, 189)"},anchor:"x",side:"left",domain:[0,.48],showspikes:!0},yaxis3:{title:"Energy [kWh]",titlefont:{color:"#d62728"},tickfont:{color:"#d62728"},anchor:"x",overlaying:"y",side:"right",position:1},yaxis4:{title:"Current [A]",titlefont:{color:"#d62728"},tickfont:{color:"#d62728"},anchor:"x",overlaying:"y2",side:"right",domain:[0,.48],position:1},yaxis5:{title:"SOC [%]",titlefont:{color:"rgb(55, 128, 191)"},tickfont:{color:"rgb(55, 128, 191)"},anchor:"x",overlaying:"y",side:"right",position:.9},showlegend:!0,autosize:!0,height:860,automargin:!0,legend:{y:0,orientation:"h",traceorder:"reversed",font:{size:16},yref:"paper"},paper_bgcolor:"#fcf2d7",plot_bgcolor:"#faebd7",modebar:{add:["v1hovermode","hoverclosest","hovercompare","togglehover","togglespikelines"]},colorway:["red","green","blue","goldenrod","magenta"]},[a,r]=[...getData()],a={x:a,y:r.map(e=>3.6*e),name:"Speed",type:"scatter",mode:"lines",line:{color:"black",shape:"linear",width:1}},l={scrollZoom:!0,responsive:!0};o.push(a),Plotly.newPlot("speedPlot",o,n,l);calculateSpeedInfo(r);document.getElementsByTagName("textarea")[0].addEventListener("keyup",updatePlotly.bind(this,o,n,l)),document.getElementById("edit-environment");var a=document.getElementById("cycle_power_dmnd"),r=document.getElementById("motor_power_cont"),o=document.getElementById("motor_power_peak"),n=document.getElementById("cycle_energy_regen_off"),l=document.getElementById("cycle_energy_regen_on"),i=document.getElementById("cycle_soc"),d=document.getElementById("cycle_current_continuous"),c=document.getElementById("cycle_current_peak");a.addEventListener("click",plotPwrDmnd),r.addEventListener("click",plotPwrActualCont),o.addEventListener("click",plotPwrActualPk),l.addEventListener("click",plotEnergyRegenOn),n.addEventListener("click",plotEnergyRegenOff),d.addEventListener("click",plotCurrentActualCont),c.addEventListener("click",plotCurrentActualPeak),i.addEventListener("click",plotSOCActualCont)}};