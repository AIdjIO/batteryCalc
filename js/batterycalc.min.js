function getData(){var textareaSpeedArray=document.getElementsByTagName("textarea")[0].value.replace(/(^\s*,)|(,\s*$)/g,"").split(",").map(element=>parseFloat(element));return[[...Array(textareaSpeedArray.length).keys()],textareaSpeedArray.map(v=>v/3.6)]}function calculateSpeedInfo(speeds){var speedInfo=document.getElementById("speed_info"),accelerationValues=speeds.map((v,i)=>(speeds[i+1]||0)-v),positiveAccValues=accelerationValues.filter(v=>0<v),positiveAccValues=(positiveAccValues.reduce((a,b)=>a+b,0)/positiveAccValues.length).toFixed(3),accelerationValues=accelerationValues.filter(v=>v<0),accelerationValues=(accelerationValues.reduce((a,b)=>a+b,0)/accelerationValues.length).toFixed(3),totalDistance=speeds.reduce((a,b)=>a+b,0)||0,averageSpeed=(totalDistance/speeds.length||0).toFixed(2);speedInfo.innerHTML=`<i>This drive cycle has a minimum speed of ${(3.6*Math.min(...speeds)).toFixed(2)||0} km/h, a maximum speed of ${(3.6*Math.max(...speeds)).toFixed(2)||0} km/h, an average speed of ${(3.6*averageSpeed).toFixed(2)} km/h, an average acceleration of ${positiveAccValues} m/s², an average deceleration of ${accelerationValues} m/s²and total distance of ${(totalDistance/1e3).toFixed(2)} km</i>`}function updatePlotly(traces,layout,config){var[labels,data]=[...getData()];calculateSpeedInfo(data),traces[0].x=labels,traces[0].y=data.map(v=>3.6*v),Plotly.react("speedPlot",traces,layout,config)}function acceleration(speeds){return speeds.map((v,i)=>(speeds[i+1]||v)-v)}function total_forces(speeds){let mass=document.getElementById("edit-vehicle-mass").value,Cd=document.getElementById("edit-drag-coefficient").value,A=document.getElementById("edit-frontal-area").value,Crr=document.getElementById("edit-rolling-resistance").value;document.getElementById("edit-vehicle-range").value;let rho=document.getElementById("edit-air-density").value,alpha=document.getElementById("edit-road-slope").value;return speeds.map((v,i)=>mass*((speeds[i+1]||v)-v+9.81*Crr*Math.cos(alpha)+9.81*Math.sin(alpha))+.5*rho*Cd*A*v*v)}function total_cycle_power(speeds){return total_forces(speeds).map((f,i)=>f*speeds[i]/1e3)}function totalMotorPowerCont(){var fr_motor_pwr_cont=document.querySelectorAll("[data-drupal-selector='edit-front-motor-power-continuous']")[0],rr_motor_pwr_cont=document.querySelectorAll("[data-drupal-selector='edit-rear-motor-power-continuous']")[0];return(fr_motor_pwr_cont?+fr_motor_pwr_cont.value:0)+(rr_motor_pwr_cont?+fr_motor_pwr_cont.value:0)}function totalMotorPowerPeak(){var fr_motor_pwr_pk=document.querySelectorAll("[data-drupal-selector='edit-front-motor-power-peak']")[0],rr_motor_pwr_pk=document.querySelectorAll("[data-drupal-selector='edit-rear-motor-power-peak']")[0];return(fr_motor_pwr_pk?+fr_motor_pwr_pk.value:0)+(rr_motor_pwr_pk?+fr_motor_pwr_pk.value:0)}function motorPwrActualCont(speeds){speeds=total_cycle_power(speeds);let motorPower=totalMotorPowerCont(),eff=document.getElementById("edit-powertrain-efficiency").value,regen=document.getElementById("edit-regen-capacity").value;return speeds.map(v=>0<=v/eff&&v/eff<motorPower?v/eff:v/eff>=motorPower?motorPower:v/eff<0&&v/eff<-motorPower*regen/100?-motorPower*regen/100:v/eff)}function motorPwrActualPeak(speeds){speeds=total_cycle_power(speeds);let motorPower=totalMotorPowerPeak(),eff=document.getElementById("edit-powertrain-efficiency").value,regen=document.getElementById("edit-regen-capacity").value;return speeds.map(v=>0<=v/eff&&v<motorPower?v:v/eff>=motorPower?motorPower:v/eff<0&&v/eff<-motorPower*regen/100?-motorPower*regen/100:v/eff)}function SOCCont(speeds){C=1e3*document.getElementById("pack_energy_container").value;speeds=currentActualCont(speeds);return soc=speeds.map((soc=100,v=>soc=Math.min(soc,100)-100*v/C))}function currentActualCont(speeds){speeds=motorPwrActualCont(speeds);let V=800;return speeds.map(p=>V*V-12*p*1e3<0?(V-Math.sqrt(V*V+12*p*1e3))/2/3:(V-Math.sqrt(V*V-12*p*1e3))/2/3)}function currentActualPeak(speeds){speeds=motorPwrActualPeak(speeds);let V=800;return speeds.map(p=>V*V-12*p*1e3<0?(V+Math.sqrt(V*V-12*p*1e3))/2/3:(V-Math.sqrt(V*V-12*p*1e3))/2/3)}function energy_regen_on(speeds){return motorPwrActualCont(speeds).map((sum=0,n=>sum+=n/3600))}function energy_regen_off(speeds){return motorPwrActualCont(speeds).map((sum=0,n=>0<n?sum+=n/3600:sum))}function plotSOCActualCont(e){var speeds;e.preventDefault(),-1<document.getElementById("speedPlot").data.map(v=>v.name).indexOf("SOC Cont")||([e,speeds]=[...getData()],speeds=SOCCont(speeds),Plotly.addTraces("speedPlot",{name:"SOC Cont",type:"scatter",x:e,y:speeds,xaxis:"x",yaxis:"y5",mode:"lines",line:{color:"rgb(55, 128, 191)",shape:"spline",smoothing:1.3,width:1}}))}function plotCurrentActualCont(e){var speeds;e.preventDefault(),-1<document.getElementById("speedPlot").data.map(v=>v.name).indexOf("Current Cont")||([e,speeds]=[...getData()],speeds=currentActualCont(speeds),Plotly.addTraces("speedPlot",{name:"Current Cont",type:"scatter",x:e,y:speeds,xaxis:"x",yaxis:"y4",mode:"lines",line:{shape:"spline",smoothing:1.3,width:1}}))}function plotCurrentActualPeak(e){var speeds;e.preventDefault(),-1<document.getElementById("speedPlot").data.map(v=>v.name).indexOf("Current Peak")||([e,speeds]=[...getData()],speeds=currentActualPeak(speeds),Plotly.addTraces("speedPlot",{name:"Current Cont",type:"scatter",x:e,y:speeds,xaxis:"x",yaxis:"y4",mode:"lines",line:{shape:"spline",smoothing:1.3,width:1}}))}function plotEnergyRegenOn(e){var speeds;e.preventDefault(),-1<document.getElementById("speedPlot").data.map(v=>v.name).indexOf("Energy Regen On")||([e,speeds]=[...getData()],speeds=energy_regen_on(speeds),Plotly.addTraces("speedPlot",{name:"Energy Regen On",type:"scatter",x:e,y:speeds,xaxis:"x",yaxis:"y3",mode:"lines",line:{shape:"spline",smoothing:1.3,width:1}}))}function plotEnergyRegenOff(e){var speeds;e.preventDefault(),-1<document.getElementById("speedPlot").data.map(v=>v.name).indexOf("Energy Regen Off")||([e,speeds]=[...getData()],speeds=energy_regen_off(speeds),Plotly.addTraces("speedPlot",{name:"Energy Regen Off",type:"scatter",x:e,y:speeds,xaxis:"x",yaxis:"y3",mode:"lines",line:{shape:"spline",smoothing:1.3,width:1}}))}function plotPwrDmnd(e){var speeds;e.preventDefault(),-1<document.getElementById("speedPlot").data.map(v=>v.name).indexOf("Power Demand")||([e,speeds]=[...getData()],speeds=total_cycle_power(speeds),Plotly.addTraces("speedPlot",{name:"Power Demand",type:"scatter",x:e,y:speeds,xaxis:"x",yaxis:"y2",mode:"lines",line:{shape:"spline",smoothing:1.3,width:1}}))}function plotPwrActualCont(e){e.preventDefault();e=document.getElementById("speedPlot").data;if(!(-1<e.map(v=>v.name).indexOf("Motor Power Actual")||-1<e.map(v=>v.name).indexOf("Max Power Limit")||-1<e.map(v=>v.name).indexOf("Min Power Limit"))){var[e,speeds]=[...getData()],speeds=motorPwrActualCont(speeds);let motorPwr=totalMotorPowerCont();Plotly.addTraces("speedPlot",{name:"Motor Power Actual",type:"scatter",x:e,y:speeds,mode:"lines",xaxis:"x",yaxis:"y2",line:{shape:"spline",smoothing:1.3,width:1}}),Plotly.addTraces("speedPlot",{name:"Max Power Limit",type:"scatter",x:e,y:e.map(v=>motorPwr),mode:"lines",xaxis:"x",yaxis:"y2",line:{color:"rgb(0, 0, 0)",shape:"linear",width:1}}),Plotly.addTraces("speedPlot",{name:"Min Power Limit",type:"scatter",x:e,y:e.map(v=>-motorPwr),mode:"lines",xaxis:"x",yaxis:"y2",line:{color:"rgb(0, 0, 0)",shape:"linear",width:1}})}}function plotPwrActualPk(e){e.preventDefault();e=document.getElementById("speedPlot").data;if(!(-1<e.map(v=>v.name).indexOf("Motor Power Peak")||-1<e.map(v=>v.name).indexOf("Max Peak Power Limit")||-1<e.map(v=>v.name).indexOf("Min Peak Power Limit"))){var[e,speeds]=[...getData()],speeds=motorPwrActualPeak(speeds);let motorPwr=totalMotorPowerPeak();Plotly.addTraces("speedPlot",{name:"Motor Power Peak",type:"scatter",x:e,y:speeds,mode:"lines",xaxis:"x",yaxis:"y2",line:{shape:"spline",smoothing:1.3,width:1}}),Plotly.addTraces("speedPlot",{name:"Max Peak Power Limit",type:"scatter",x:e,y:e.map(v=>motorPwr),mode:"lines",yaxis:"y2",line:{color:"rgb(0, 0, 0)",shape:"linear",width:1},visible:"legendonly"}),Plotly.addTraces("speedPlot",{name:"Min Peak Power Limit",type:"scatter",x:e,y:e.map(v=>-motorPwr),mode:"lines",yaxis:"y2",line:{color:"rgb(0, 0, 0)",shape:"linear",width:1},visible:"legendonly"})}}(Drupal=>{Drupal.behaviors.plotlyjs={attach:function(context,settings){var traces=[],layout={title:"Vehicle Test Cycle",xaxis:{domain:[0,.9],tickmode:"linear",tick0:0,dtick:500,anchor:"y",showspikes:!0},xaxis2:{domain:[0,.8],domain:[0,1],title:"time [s]",anchor:"y2",categoryorder:"array",showspikes:!0},yaxis:{title:"speed [km/h]",tickmode:"linear",tick0:0,dtick:20,titlefont:{color:"black"},tickfont:{color:"#black"},anchor:"x",domain:[.52,1],showspikes:!0},yaxis2:{title:"Power [kW]",titlefont:{color:"rgb(148, 103, 189)"},tickfont:{color:"rgb(148, 103, 189)"},anchor:"x",side:"left",domain:[0,.48],showspikes:!0},yaxis3:{title:"Energy [kWh]",titlefont:{color:"#d62728"},tickfont:{color:"#d62728"},anchor:"x",overlaying:"y",side:"right",position:1},yaxis4:{title:"Current [A]",titlefont:{color:"#d62728"},tickfont:{color:"#d62728"},anchor:"x",overlaying:"y2",side:"right",domain:[0,.48],position:1},yaxis5:{title:"SOC [%]",titlefont:{color:"rgb(55, 128, 191)"},tickfont:{color:"rgb(55, 128, 191)"},anchor:"x",overlaying:"y",side:"right",position:.9},showlegend:!0,autosize:!0,height:860,automargin:!0,legend:{y:0,orientation:"h",traceorder:"reversed",font:{size:16},yref:"paper"},paper_bgcolor:"#fcf2d7",plot_bgcolor:"#faebd7",modebar:{add:["v1hovermode","hoverclosest","hovercompare","togglehover","togglespikelines"]},colorway:["red","green","blue","goldenrod","magenta"]},[labels,speeds]=[...getData()],labels={x:labels,y:speeds.map(v=>3.6*v),name:"Speed",type:"scatter",mode:"lines",line:{color:"black",shape:"linear",width:1}},config={scrollZoom:!0,responsive:!0};traces.push(labels),Plotly.newPlot("speedPlot",traces,layout,config);calculateSpeedInfo(speeds);document.getElementsByTagName("textarea")[0].addEventListener("keyup",updatePlotly.bind(this,traces,layout,config)),document.getElementById("edit-environment");var labels=document.getElementById("cycle_power_dmnd"),speeds=document.getElementById("motor_power_cont"),traces=document.getElementById("motor_power_peak"),layout=document.getElementById("cycle_energy_regen_off"),config=document.getElementById("cycle_energy_regen_on"),cycleSOC=document.getElementById("cycle_soc"),cycleCurrentCont=document.getElementById("cycle_current_continuous"),cycleCurrentPeak=document.getElementById("cycle_current_peak");labels.addEventListener("click",plotPwrDmnd),speeds.addEventListener("click",plotPwrActualCont),traces.addEventListener("click",plotPwrActualPk),config.addEventListener("click",plotEnergyRegenOn),layout.addEventListener("click",plotEnergyRegenOff),cycleCurrentCont.addEventListener("click",plotCurrentActualCont),cycleCurrentPeak.addEventListener("click",plotCurrentActualPeak),cycleSOC.addEventListener("click",plotSOCActualCont)}}})((jQuery,Drupal));