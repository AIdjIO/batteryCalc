async function makepdf(){document.getElementById;pdfMake.fonts={Helvetica:{normal:"Helvetica.ttf",bold:"Helvetica-Bold.ttf",italics:"Helvetica-Oblique.ttf",bolditalics:"Helvetica-BoldOblique.ttf"},Roboto:{normal:"Roboto-Regular.ttf",bold:"Roboto-Medium.ttf",italics:"Roboto-Italic.ttf",bolditalics:"Roboto-MediumItalic.ttf"}};let e=document.getElementById("calcVersion").innerHTML,t=document.getElementById("edit-batt-title").value,n=document.getElementById("cell_table"),a={mass:document.getElementById("edit-vehicle-mass"),frtArea:document.getElementById("edit-frontal-area"),tireSize:document.getElementById("edit-wheel-radius"),rollResistance:document.getElementById("edit-rolling-resistance"),aeroDrag:document.getElementById("edit-drag-coefficient")},i={range:document.getElementById("edit-vehicle-range")},o={useableCapacity:document.getElementById("edit-useable-capacity"),regenBraking:document.getElementById("edit-regen-capacity"),powertrainEff:document.getElementById("edit-powertrain-efficiency"),ancillaryLoad:document.getElementById("edit-ancillary-energy"),testCycle:document.getElementById("edit-cycle-select")},l={diffRatio:document.getElementById("edit-drive-ratio-differential"),driveRatio:document.getElementById("edit-drive-ratio-gear")},r=[...document.getElementsByName("Drive_Type")].filter(e=>e.checked)[0],c=[...document.getElementById("motor-container").querySelectorAll("label")],d=[...document.getElementById("motor-container").querySelectorAll("label")].map(e=>e.nextElementSibling),s={airDensity:document.getElementById("edit-air-density"),roadSlope:document.getElementById("edit-road-slope")},m={cycleInfo:document.getElementById("speed_info"),vehicleResults:document.getElementById("results"),packResults:document.getElementById("packParameters")},g=[document.getElementById("speedPlotPreview"),document.getElementById("speedPlotPackSize"),document.getElementById("speedPlotPackSpec")],u=[[...[...n.querySelectorAll("th")].filter((e,t)=>0!=t).map(e=>e.innerText.toUpperCase())],[...[...n.querySelectorAll("input[type=radio]:checked")[0].closest("tr").querySelectorAll("td")].filter((e,t)=>0!=t).map(e=>e.innerHTML)]],[p]=u,y=p.map((e,t)=>u.map(e=>e[t])),f=`${t}\nTest Cycle: ${o.testCycle.options[o.testCycle.options.selectedIndex].text}\n\n\t\t\t\t\tAverage road slope  + ${s.roadSlope.value}° and air density of ${s.airDensity.value}kg/m3\n\n\t\t\t\t\tRequired ${i.range.previousElementSibling.innerHTML}: ${i.range.value}\n\n\t\t\t\t\tBattery Pack Spec: ${m.packResults.innerText.replace(/\s(Battery Pack Specification)\s/,"")}\n\n\t\t\t\t\tSelected Cell: ${JSON.stringify(y).replace(/[\"\[\]]+/gm,"").replace}`,h=[];h.push({text:t,style:"coverTitle",absolutePosition:{x:20,y:150}},{text:"Preliminary Battery Sizing Calculations Report for Vehicle Application",style:"coverSubTitle",absolutePosition:{x:20,y:275}},{qr:f,foreground:"black",background:"white",fit:"350",absolutePosition:{x:140,y:500},pageBreak:"after"}),h.push({toc:{title:{text:"Table of Contents",style:"header"}},pageBreak:"after"}),h.push({text:"Vehicle Test Cycle",style:"header",tocItem:!0},{text:["All values are assumed on the following test cycle:\n",{text:o.testCycle.options[o.testCycle.options.selectedIndex].text+"\n",italics:!0},{text:"Average road slope "+s.roadSlope.value+"° and air density of "+s.airDensity.value+"kg/m3\n"}],bold:!0}),await Plotly.toImage(g[0],{format:"svg"}).then(e=>{h.push({svg:decodeURIComponent(e).replace("data:image/svg+xml,",""),alignment:"center",width:500})}),h.push({text:m.cycleInfo.innerText.replace(/\n\s+/gm,""),italics:!0},{text:"\n"}),h.push({text:"Vehicle Target",style:"header",tocItem:!0},{text:"Required "+i.range.previousElementSibling.innerHTML+" :"+i.range.value},{text:"\n"}),h.push({text:"Assumed Vehicle Specification",style:"header",tocItem:!0},{text:"Vehicle Parameters: ",decoration:"underline",bold:!0},{table:{headerows:1,body:[[...Object.keys(a).map(e=>a[e].previousElementSibling.innerHTML)],[...Object.keys(a).map(e=>"tireSize"!=e?a[e].value:a[e].options[a[e].options.selectedIndex].text)]]}},{text:"\n"},{text:"Drivetrain Parameters: ",decoration:"underline",bold:!0},{table:{headerows:1,body:[[r.parentElement.parentElement.parentElement.previousElementSibling.firstElementChild.innerHTML,...Object.keys(l).map(e=>l[e].previousSibling.previousSibling.innerHTML)],[r.nextElementSibling.innerHTML,...Object.keys(l).map(e=>l[e].value)]]}},{text:"\n"},{text:"Motor Specifications: ",decoration:"underline",bold:!0},{table:{headerows:1,body:[[r.parentElement.parentElement.parentElement.previousElementSibling.firstElementChild.innerHTML,...c.map(e=>e.textContent)],[r.nextElementSibling.innerHTML,...d.map(e=>e.value)]]}},{text:"",pageBreak:"after"}),h.push({text:"Vehicle Power and Energy",style:"header",tocItem:!0}),await Plotly.toImage(g[1],{format:"svg"}).then(e=>{h.push({svg:decodeURIComponent(e).replace("data:image/svg+xml,",""),alignment:"center",width:500})}),h.push({text:m.vehicleResults.innerText.replace(/\n\s+/gm,""),italics:!0},{text:"\n",pageBreak:"after"}),h.push({text:"Vehicle Battery Pack SOC, Current",style:"header",tocItem:!0}),await Plotly.toImage(g[2],{format:"svg"}).then(e=>{h.push({svg:decodeURIComponent(e).replace("data:image/svg+xml,",""),alignment:"center",width:500,pageBreak:"after"})}),h.push({text:"Vehicle Battery Pack Specification",style:"header",tocItem:!0}),h.push({text:m.packResults.innerText.replace(/\s(Battery Pack Specification)\s/,""),italics:!0},{text:"\n"}),h.push({text:"Selected Cell Specification",style:"header",tocItem:!0},{table:{headerows:1,body:y}});let b={defaultStyle:{fontSize:12},background:function(e,t){return 1==e?{image:b64images.batteryPack,pageBreak:"after",width:500,absolutePosition:{x:50,y:197},opacity:.5}:{}},pageSize:"A4",pageOrientation:"portrait",pageMargins:[50,100,50,20],header:function(t,n,a){if(1!=t)return[{columns:[{image:b64images.logo,width:150,absolutePosition:{x:1,y:1}},{text:"Calculator: "+e,absolutePosition:{x:250,y:1}},{qr:f,foreground:"black",background:"white",fit:"75",absolutePosition:{x:531,y:1}}]}]},footer:function(e,t){return 1==e?{text:"Report generated on "+(new Date).toLocaleDateString("en-uk",{weekday:"long",year:"numeric",month:"short",day:"numeric"}),margin:[72,40]}:{text:e.toString()+" of "+t,alignment:"right",margin:[72,40]}},content:h,styles:{coverTitle:{fontSize:40,alignment:"center",color:"#135898",font:"Roboto",bold:!0},coverSubTitle:{fontSize:35,alignment:"center",color:"black",bold:!0},header:{fontSize:18,bold:!0},subheader:{fontSize:15,bold:!0},quote:{italics:!0},small:{fontSize:8}}};console.log("download");pdfMake.createPdf(b).open()}async function getBase64Image(e=".main-svg"){return new Promise((t,n)=>{const a=new Image,i=document.querySelector(e),o="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(i.outerHTML);a.onload=(()=>{var e=document.createElement("canvas");e.width=a.width,e.height=a.height;const n=e.getContext("2d");n.drawImage(a,0,0);const i=e.toDataURL("image/png");t(i)}),a.onerror=(e=>{n(e)}),a.src=o})}